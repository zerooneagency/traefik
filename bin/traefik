#!/bin/sh
#
# This script should be run via curl:
#   sh -c "$(curl -fsSL https://raw.githubusercontent.com/zerooneagency/traefik/master/bin/traefik)"
# or wget:
#   sh -c "$(wget -qO- https://raw.githubusercontent.com/zerooneagency/traefik/master/bin/traefik)"
#
# As an alternative, you can first download the install script and run it afterwards:
#   wget https://raw.githubusercontent.com/zerooneagency/traefik/master/bin/traefik
#   ./traefik
#
set -e

traefik_parent_path=${CODE_DIR:-$HOME/code}
traefik_path=${TRAEFIK_DIR:-$traefik_parent_path/.traefik}
domains_file_path=$traefik_path/.domains

# clone repository
if [ ! -d $traefik_path ]
then
  mkdir -p $traefik_parent_path
  git clone git@github.com:zerooneagency/traefik.git $traefik_path
fi

# Add new domains to file
touch $domains_file_path
generate_cert=""
for domain in "$@"
do
  if ! grep -Fxq "$domain" $domains_file_path
  then
    echo "$domain" >> $domains_file_path
    generate_cert="true"
  fi
done

# generate certificates
if [[ ! -z "$generate_cert" ]] || [[ ! -f $traefik_path/certs/localhost.pem ]]; then
  hosts="localhost 127.0.0.1 ::1"

  while IFS= read -r host;
  do
    if [[ ! -z "$host" ]]; then
      hosts="$hosts $host *.$host"
    fi
  done < $domains_file_path

  mkcert -cert-file $traefik_path/certs/localhost.pem -key-file $traefik_path/certs/localhost-key.pem $hosts

  # restart docker
  docker-compose -f $traefik_path/docker-compose.yml down
fi

# start docker
docker-compose -f $traefik_path/docker-compose.yml up -d
